# 説明動画
https://youtu.be/ESNyVqHuqVc

# 概要
監視カメラで撮影した動画を別プログラムで処理し、保存したアーカイブデータを確認するために作成しました。
ほぼすべてをAIを使って作成してみたのですが、うまくできているのではないかと思います。
作成も早くできたのですが、修正ループになることもあったのでうまく使える方法を模索したいです。

# NAS監視カメラデータ管理システム

ローカルのNAS上に保存された監視カメラ映像（MP4ファイル）をブラウザ上で検索・プレビュー・ダウンロードできるWebアプリケーションです。FastAPIとJinja2テンプレート、JavaScriptによるフロントエンド機能を組み合わせ、カテゴリ／機器名／日時など多彩なフィルターで目的の映像を素早く絞り込めます。

## 🎯 システム概要

このシステムは、ネットワーク上のストレージ（NAS）に保存されている監視カメラの動画ファイルをスキャンし、Webブラウザ上で一覧表示・再生・分類するためのアプリケーションです。

### ディレクトリ構造
正しいディレクトリ構造に対応し、以下の階層でファイルを管理します：

```
NAS/
├── 機器名1/
│   ├── 年/
│   │   ├── 月/
│   │   │   ├── 日/
│   │   │   │   ├── *.txt              # 日付フォルダ直下
│   │   │   │   ├── エラーフォルダ/    # この中に.mp4
│   │   │   │   ├── その他フォルダ/    # この中に.mp4
│   │   │   │   ├── 誤検知フォルダ/    # この中に.mp4
│   │   │   │   └── 人物フォルダ/      # この中に.mp4
```

## ✨ 主な機能

### ディレクトリ自動スキャン
- NAS上の指定フォルダを再帰的に検索
- 機器名フォルダ → カテゴリフォルダ → 年月日フォルダ配下のMP4ファイルを検出・キャッシュ

### カテゴリ／機器名フィルタリング
- 「エラー」「誤検知」「人物」「その他」のカテゴリで検索
- 機器名（例：cam01, cam02…）での絞り込み
- 複数選択による組み合わせフィルタ

### 日付・時間範囲指定検索
- 日付（YYYY-MM-DD）での期間指定
- 日中時間帯（HH:MM）での絞り込み

### ページネーション対応
- 1ページあたり最大100件（デフォルト50件）で結果を表示
- 大量データでも快適に操作

### 動画プレビュー＆ダウンロード
- モーダル上でメディアをストリーミング再生
- レンジリクエストによるシーク機能
- ワンクリックでMP4ファイルをダウンロード

### リアルタイム通知
- 検索／更新開始完了、エラー発生などを画面右上の通知ポップアップでお知らせ

### キーボードショートカット
- `Ctrl+R`：データ再取得
- `Ctrl+F`：フィルター適用
- `Esc`：モーダル閉じる

### 新機能
- 📁 **ファイルパス表示**: 各MP4ファイルの正確な場所を表示
- 📊 **統計情報**: ファイル数、機器数、最終スキャン時刻を表示
- 🔄 **リアルタイム更新**: リフレッシュボタンでデータを即座に更新
- 📋 **パスコピー**: ファイルパスをクリップボードにコピー
- 🎯 **動的検出**: 機器名とカテゴリを自動検出

## 📋 必要環境

- **Python**: 3.8以上
- **OS**: Windows/Linux/macOS
- **ライブラリ**: FastAPI, Uvicorn, Jinja2, 標準ライブラリ
- **ブラウザ**: Chrome・Firefox等

## 🚀 セットアップ手順

### 1. リポジトリをクローン
```bash
git clone https://github.com/fk009/nas_video_viewer
```

### 2. Pythonパッケージをインストール
```bash
pip install fastapi uvicorn jinja2 python-multipart
```

### 3. ファイル構成確認
```
.
├── main.py              # FastAPIサーバー実装
├── static/              # CSS・JavaScriptファイル群
│   ├── video-player.js  # 動画プレビュー制御
│   ├── utils.js         # 通知・debounce/throttle等ユーティリティ
│   ├── table.js         # テーブル選択・統計更新
│   ├── filters.js       # フィルタリング＆検索処理
│   ├── api.js           # FetchによるAPI通信
│   └── style.css        # 全体スタイル定義
└── templates/
    └── index.html       # メイン画面テンプレート
```

### 4. NASパス設定
`main.py` 内の `NAS_BASE_PATH` を監視カメラ映像フォルダのルートパスに変更：

```python
NAS_BASE_PATH = "H:/Nas_Video_Viewer/fastapi_table_app/TEST_NAS"
```

### 5. サーバー起動
```bash
# 起動方法
uvicorn main:app --host 0.0.0.0 --port 8010 --reload

# 仮想環境で起動する場合の参考
fastapi_table_app\fast_venv\Scripts\Activate.ps1; cd fastapi_table_app; uvicorn main:app --host 0.0.0.0 --port 8010 --reload
```

### 6. ブラウザアクセス
ブラウザで [http://localhost:8010](http://localhost:8010) を開く


## 💡 使い方

1. ページ上部のカテゴリ・機器名チェックボックスで絞り込み
2. 日付／時間入力欄で範囲指定
3. 「検索」ボタンまたは`Ctrl+F`でフィルター適用
4. テーブルの行をクリックすると、詳細情報とプレビュー用モーダルが表示
5. モーダル内の再生ボタンで映像をストリーミング、ダウンロードリンクから取得可能

## 📡 API エンドポイント

### GET /api/data
データ取得（フィルタリング対応）
```
パラメータ:
- start_date: 開始日 (YYYY-MM-DD)
- end_date: 終了日 (YYYY-MM-DD)  
- devices: 機器名 (カンマ区切り)
- categories: カテゴリ (カンマ区切り)
- per_page: 1ページあたりの件数
```

### GET /api/devices
機器名一覧取得

### GET /api/categories  
カテゴリ一覧取得

### POST /api/refresh
データ強制再スキャン

## 🔧 カスタマイズ

### カテゴリマッピング変更
`main.py` の `NASDataScanner` クラス内で変更可能：

```python
self.category_mapping = {
    "エラーフォルダ": "エラー",
    "その他フォルダ": "その他", 
    "誤検知フォルダ": "誤検知",
    "人物フォルダ": "人物"
}
```

### フロントエンド設定
- ロギングレベルやCORS設定は `main.py` で調整可能
- 通知の色・表示時間は `utils.js` の `bgColors／deleteTime` で編集
- テーブルページサイズは `/api/data?per_page=` クエリパラメータで変更可能

## 🚨 トラブルシューティング

### よくある問題

1. **データが表示されない**
   - NASパスが正しく設定されているか確認
   - ディレクトリ構造が正しいか確認
   - ファイルアクセス権限を確認

2. **ファイルが検出されない**
   - MP4ファイルがカテゴリフォルダ内に配置されているか確認
   - ファイル拡張子が小文字か確認（.mp4）

3. **パフォーマンスが遅い**
   - ファイル数が多い場合、インデックス作成を検討
   - ネットワーク速度を確認

### エラーハンドリング
- **NASアクセス失敗時**: 自動的にサンプルデータにフォールバック
- **権限問題**: ユーザーに警告メッセージを表示
- **詳細ログ**: アプリケーション実行時のコンソール出力で確認可能

---

**Version**: 2.0.0  
**Last Updated**: 2025年9月15日  
**Author**: NAS監視カメラシステム開発チーム
